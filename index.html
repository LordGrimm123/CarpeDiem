<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carpe Diem Stock Simulator</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #0d0d0d;
      color: #f0f0f0;
    }
    header {
      background: linear-gradient(90deg, #1a1a40, #3b0a45);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      padding: 20px;
    }
    .hidden { display: none; }
    .login-box {
      max-width: 350px;
      margin: 120px auto;
      background: #1a1a1a;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
      text-align: center;
    }
    input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 6px;
    }
    button {
      padding: 10px 20px;
      margin: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #8b5cf6;
      color: white;
      font-weight: bold;
    }
    button:hover { background: #6d28d9; }
    .stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      background: #1e1e2f;
      padding: 10px;
      border-radius: 10px;
    }
    .stock-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .stock-card {
      background: #1e1e2f;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .stock-card:hover { transform: scale(1.05); }
    canvas { background: #111; border-radius: 8px; margin-top: 15px; }
    .admin-controls { margin-top: 20px; }
    .admin-controls button { background: #f59e0b; }
    .admin-controls button:hover { background: #d97706; }
  </style>
</head>
<body>
  <header>Carpe Diem Stock Simulator</header>

  <!-- LOGIN -->
  <div id="loginSection" class="login-box">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="container hidden">
    <h2 id="roleHeader"></h2>

    <!-- Stats -->
    <div class="stats" id="traderStats" style="display:none;">
      <div>Working Capital: â‚¹<span id="workingCap">0</span></div>
      <div>Invested: â‚¹<span id="investedCap">0</span></div>
      <div>P/L: <span id="profitLoss">0%</span></div>
    </div>

    <!-- Stock List -->
    <h3>Stocks</h3>
    <div class="stock-list" id="stockList"></div>

    <!-- Stock Details -->
    <div id="stockDetails" class="hidden">
      <h3 id="selectedStockName"></h3>
      <canvas id="priceChart" width="600" height="200"></canvas>
      <div style="margin-top:10px;">
        <input type="number" id="quantity" placeholder="Quantity" min="1">
        <button onclick="buyStock()">Buy</button>
        <button onclick="sellStock()">Sell</button>
      </div>
      <div class="admin-controls hidden" id="adminControls">
        <button onclick="adjustPrice(0.1)">Increase 10%</button>
        <button onclick="adjustPrice(-0.1)">Decrease 10%</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE + APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ðŸ”‘ Config
    const firebaseConfig = {
      apiKey: "AIzaSyC72GZrrjG4UIR3qzDs-I2QWIgSFd4Yehs",
      authDomain: "carpediem-f6948.firebaseapp.com",
      projectId: "carpediem-f6948",
      storageBucket: "carpediem-f6948.firebasestorage.app",
      messagingSenderId: "705608113463",
      appId: "1:705608113463:web:eb70088734b33486c70eb2"
    };

    const APP_ID = "carpe_diem";
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentRole = null;
    let stocks = {};
    let selectedStock = null;
    let chartCtx, chartData = [];

    // Seed stock list
    const STOCK_NAMES = [
      "Reliance Industries", "Tata Consultancy", "Infosys", "HDFC Bank", "ICICI Bank",
      "State Bank of India", "Bharti Airtel", "HCL Tech", "Asian Paints", "Wipro",
      "Tata Motors", "Adani Green", "Hindustan Unilever", "Larsen & Toubro", "Bajaj Finance",
      "Kotak Mahindra Bank", "UltraTech Cement", "NTPC", "JSW Steel", "Tech Mahindra",
      "Power Grid", "Adani Ports", "Axis Bank", "Maruti Suzuki", "Grasim Industries"
    ];

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        currentUser = cred.user;

        const roleRef = doc(db, "artifacts", APP_ID, "public", "data", "roles", currentUser.uid);
        const roleSnap = await getDoc(roleRef);
        if (!roleSnap.exists()) {
          alert("Role not found for this user");
          return;
        }
        currentRole = roleSnap.data().role;

        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("roleHeader").innerText = `Welcome, ${currentRole}`;
        if (currentRole === "trader") document.getElementById("traderStats").style.display = "flex";

        loadStocks();
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    }

    async function loadStocks() {
      const stocksRef = collection(db, "artifacts", APP_ID, "public", "data", "stocks");
      const snap = await getDocs(stocksRef);
      if (snap.empty) {
        // Seed 25 stocks with baseline
        for (let name of STOCK_NAMES) {
          const stockId = name.replace(/\s+/g, "_").toLowerCase();
          await setDoc(doc(stocksRef, stockId), { name, baseline: 500 + Math.random()*500, baselineVer: Date.now() });
        }
      }
      const newSnap = await getDocs(stocksRef);
      newSnap.forEach(d => stocks[d.id] = d.data());
      renderStockList();
      startTicker();
    }

    function renderStockList() {
      const listDiv = document.getElementById("stockList");
      listDiv.innerHTML = "";
      Object.entries(stocks).forEach(([id, s]) => {
        const card = document.createElement("div");
        card.className = "stock-card";
        card.innerHTML = `<strong>${s.name}</strong><br>â‚¹<span id="price-${id}"></span>`;
        card.onclick = () => openStock(id);
        listDiv.appendChild(card);
      });
    }

    function calcPrice(stock, t) {
      const base = stock.baseline;
      const seed = Math.sin((t/4000) + stock.baselineVer/10000);
      const rand = (seed * 10); // Â±10
      return Math.max(1, (base + rand).toFixed(2));
    }

    function startTicker() {
      setInterval(() => {
        const t = Date.now();
        for (let [id, s] of Object.entries(stocks)) {
          const p = calcPrice(s, t);
          const el = document.getElementById("price-"+id);
          if (el) el.textContent = p;
          if (selectedStock===id) updateChart(p);
        }
      }, 1000); // smooth refresh, but drift is 4s cycle
    }

    function openStock(id) {
      selectedStock = id;
      const s = stocks[id];
      document.getElementById("stockDetails").classList.remove("hidden");
      document.getElementById("selectedStockName").innerText = s.name;
      chartCtx = document.getElementById("priceChart").getContext("2d");
      chartData = [];
      if (currentRole==="admin") document.getElementById("adminControls").classList.remove("hidden");
    }

    function updateChart(price) {
      chartData.push(price);
      if (chartData.length > 50) chartData.shift();
      chartCtx.clearRect(0,0,600,200);
      chartCtx.beginPath();
      chartCtx.strokeStyle="#8b5cf6";
      chartCtx.moveTo(0,200-chartData[0]);
      chartData.forEach((v,i)=>chartCtx.lineTo(i*12,200-(v/10)));
      chartCtx.stroke();
    }

    async function adjustPrice(factor) {
      if (!selectedStock) return;
      const s = stocks[selectedStock];
      const newBase = s.baseline * (1+factor);
      await updateDoc(doc(db, "artifacts", APP_ID, "public", "data", "stocks", selectedStock), {
        baseline: newBase, baselineVer: Date.now()
      });
      s.baseline = newBase;
      s.baselineVer = Date.now();
    }

    function buyStock(){ alert("Buy not fully implemented in this demo."); }
    function sellStock(){ alert("Sell not fully implemented in this demo."); }
  </script>
</body>
</html>
