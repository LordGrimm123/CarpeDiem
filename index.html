<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carpe Diem – Stock Simulator</title>
  <style>
    :root{
      --bg:#0b132b; --panel:#14213d; --card:#1b294a;
      --accent:#4cafef; --accent-2:#357abd;
      --text:#ffffff; --muted:#eef4ff; --muted-2:#d7e3ff;
      --good:#3ddc97; --bad:#ff6b6b; --border:#ffffff33;
    }
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,#0e1a34,#18335f);padding:14px;text-align:center;font-weight:800}
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}
    .hidden{display:none!important}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .btn{padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;border:1px solid transparent}
    .btn-primary{background:var(--accent);color:#041426}
    .btn-primary:hover{background:var(--accent-2)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-ghost:hover{background:#ffffff14}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .tile{padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1c37;cursor:pointer}
    .tile .name{font-weight:800}
    .tile .price{margin-top:2px;font-weight:800}
    canvas{width:100%;height:220px;background:#0b1730;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px 10px;text-align:left}
    th{color:var(--muted-2);border-bottom:1px solid var(--border)}
    tr.data{background:#0f1c37;border:1px solid var(--border)}
  </style>
</head>
<body>
  <header>Carpe Diem – Stock Simulator</header>
  <main class="wrap">
    <!-- LOGIN -->
    <section id="loginSection" class="panel">
      <form id="loginForm">
        <h2>Sign in</h2>
        <input id="email" type="email" placeholder="Email" required class="card"/><br><br>
        <input id="password" type="password" placeholder="Password" required class="card"/><br><br>
        <button id="loginBtn" class="btn btn-primary">Log in</button>
        <span id="loginError"></span>
      </form>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <div class="panel">
        <strong id="roleHeader"></strong>
        <button id="logoutBtn" class="btn btn-ghost" style="float:right">Log out</button>
      </div>

      <!-- TRADER metrics (only trader sees) -->
      <div id="traderMetrics" class="panel hidden">
        <div>Working Capital: ₹<span id="workingCap">0.00</span></div>
        <div>Invested Capital: ₹<span id="investedCap">0.00</span></div>
        <div>Profit/Loss: <span id="profitLoss">0%</span></div>
      </div>

      <!-- STOCK LIST -->
      <div class="panel">
        <h3>Stocks</h3>
        <div id="stockList" class="grid grid-3"></div>
      </div>

      <!-- DETAILS -->
      <section class="panel">
        <!-- Trader View -->
        <div id="traderView">
          <h3 id="detailName">Select a stock</h3>
          <div id="detailPrice"></div>
          <canvas id="chart"></canvas>
          <div>
            <input id="qty" type="number" min="1" value="1"/>
            <button id="buyBtn" class="btn btn-primary">Buy</button>
            <button id="sellBtn" class="btn btn-ghost">Sell</button>
          </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="hidden">
          <h3>Admin Controls</h3>
          <button id="raiseBtn" class="btn btn-primary">Increase 10%</button>
          <button id="lowerBtn" class="btn btn-ghost">Decrease 10%</button>
          <hr>
          <h4>Trader Portfolio Viewer</h4>
          <select id="traderSelect"></select>
          <div id="portfolioWrap" class="card hidden">
            <h4 id="pfTitle"></h4>
            <table>
              <thead><tr><th>Stock</th><th>Qty</th><th>Value</th></tr></thead>
              <tbody id="pfTable"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC72GZrrjG4UIR3qzDs-I2QWIgSFd4Yehs",
      authDomain: "carpediem-f6948.firebaseapp.com",
      projectId: "carpediem-f6948",
      storageBucket: "carpediem-f6948.firebasestorage.app",
      messagingSenderId: "705608113463",
      appId: "1:705608113463:web:eb70088734b33486c70eb2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const TICK_MS = 3000;
    const STOCKS = ["Reliance","TCS","Infosys","HDFC","ICICI","SBI"];
    let stocks = {};

    function jumpPrice(stock){
      const base = stock.price||500;
      const change = (1+(Math.random()*0.02+0.01)*(Math.random()<0.5?-1:1));
      stock.price = +(base*change).toFixed(2);
    }

    setInterval(()=>{ 
      STOCKS.forEach(n=>{
        if(!stocks[n]) stocks[n]={name:n,price:500+Math.random()*500};
        jumpPrice(stocks[n]);
        document.getElementById("p-"+n).textContent = stocks[n].price;
      });
    },TICK_MS);

    // UI rendering
    const stockList=document.getElementById("stockList");
    STOCKS.forEach(n=>{
      const div=document.createElement("div");
      div.className="tile";
      div.innerHTML=`<div class="name">${n}</div><div class="price">₹ <span id="p-${n}">--</span></div>`;
      stockList.appendChild(div);
    });

    // Auth
    onAuthStateChanged(auth,user=>{
      if(user){
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
      } else {
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
      }
    });
    document.getElementById("loginForm").addEventListener("submit",async e=>{
      e.preventDefault();
      await signInWithEmailAndPassword(auth,document.getElementById("email").value,document.getElementById("password").value);
    });
    document.getElementById("logoutBtn").addEventListener("click",()=>signOut(auth));
  </script>
</body>
</html>
